<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="robots" content="index, follow" />
    <meta name="author" content="ITI Attendance System" />

    <!-- Search Engine -->
    <meta name="description" content="description about ITI Attendance System" />
    <meta name="image" content="images/logo.png" />
    <!-- Twitter -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="page title" />
    <meta name="twitter:description" content="description about ITI Attendance System" />
    <!-- Open Graph general (Facebook, Pinterest & Google+) -->
    <meta name="og:title" content="page title" />
    <meta name="og:description" content="description about ITI Attendance System" />
    <meta name="og:type" content="website" />

    <!-- frameworks CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css" />

    <!-- font awesome css -->
    <link rel="stylesheet" href="css/line-awesome.min.css">
    <!-- custom style -->
    <link rel="stylesheet" href="css/style.css" />

    <title>ITI Attendance System</title>
    <link rel="shortcut icon" href="images/fav.svg" type="image/x-icon" />

    <!--[if lt IE 9]>
      <script src="js/html5shiv.min.js"></script>
      <script src="js/popper.min.js"></script>
    <![endif]-->
</head>

<body>

    <!-- loading window -->
    <!-- <div class="load">
        <div class="circle">
            <div class="circle__spin">
                <svg>
                    <circle cx="50%" cy="50%" r="67px"></circle>
                </svg>
            </div>
        </div>
    </div> -->

    <div class="page login-bg">
        <div class="page-single">
            <div class="container">
                <div class="row">
                    <div class="col mx-auto">
                        <div class="row justify-content-center">
                            <div class="col-sm-10 col-md-8 col-lg-5">
                                <div class="card">
                                    <div class="p-4 pt-6 text-center">
                                        <h3 class="mb-2">Attendance Confirmation </h3>
                                    </div>
                                    <form class="card-body pt-0" id="confirmAttendanceForm"
                                        name="confirmAttendanceForm">
                                        <div class="form-group">
                                            <label class="form-label" for="selectStudent">Select Student</label>
                                            <select class="form-control" id="selectStudent">
                                                <option id="default-option" value="default-option" selected disabled>
                                                    Select Student</option>
                                            </select>
                                        </div>

                                        <div class="button-block">
                                            <button type="button" id="confirmAttendance_btn"
                                                class="btn btn-primary btn-block" onclick="setTime()"
                                                data-toggle="modal" data-target="#confirmModal">confirm
                                                Attendance</button>
                                        </div>

                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- confirmation Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-labelledby="confirmModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalLabel">Recorded Success</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <h3><span class="main-color">Username: </span><span class="font-color" id="username"></span></h3>
                    <h3><span class="main-color">Time: </span><span class="font-color" id="time_recorder"></span></h3>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <!-- <script type="text/javascript" src="data.json"></script> -->


    <script>

        let reports = [];
        let flag = ''

        //GET ALL USERNAMES IN JSON FILE
        async function getUsernames() {
            const response = await fetch(`http://localhost:3000/employees`);
            const data = await response.json();
            console.log(data);
            //set value and id
            document.getElementById('selectStudent')
            for (var i = 0; i < data.length; i++) {
                $("#selectStudent").append($('<option>', {
                    value: data[i].username,
                    id: data[i].id
                }).text(data[i].username));
            }

        } getUsernames();

        //ADD DISABLED ATTRIBUTE TO BUT BEFORE SELECT
        if ($('#selectStudent option').val() == 'default-option') {
            $('#confirmAttendance_btn').prop('disabled', true);
        }

        //select user to attend
        function selectUserToAttend() {
            $('#selectStudent').change(function () {
                $('#confirmAttendance_btn').prop('disabled', false);
                var username = $(this).val();
                //set username at modal
                $('#username').append(`"${username}"`)

            })
            //empty username after confirmation
            $('#confirmModal').on('hidden.bs.modal', function (e) {
                $('#username').empty()
            })
        } selectUserToAttend()

        //REPORT
        const addReport = (ev) => {
            let report = {
                // id,
                "date": $('#time_recorder').val(),
                "time": $('#time_recorder').val(),
                "attendance": 1,
                "late": 0,
                "excuse": 0,
                "absence": 0
            }
        };

        //POST DATA TOP APIA
        async function postReportData() {
            alert('Processing Data !!')
            var id = $('#selectStudent').children(":selected").attr("id");
            alert(id, "id")
            const response = await fetch(`http://localhost:3000/reports?id=${id}`, {
                method: 'POST',
                mode: 'cors',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json'
                },
                redirect: 'follow',
                referrerPolicy: 'no-referrer',
                body: addReport()
            })
                .then((response) => response.json())
                .then((reportsData) => {
                    console.log("Success:", data);
                })
                .catch((error) => {
                    console.error("Error:", error);
                });

            return
        }





        function getTimeStamp() {
            var now = new Date();
            return ((now.getMonth() + 1) + '/' + (now.getDate()) + '/' + now.getFullYear() + " " + now.getHours() + ':'
                + ((now.getMinutes() < 10) ? ("0" + now.getMinutes()) : (now.getMinutes())) + ':' + ((now.getSeconds() < 10) ? ("0" + now.getSeconds()) : (now.getSeconds())));
        }

        function setTime() {
            document.getElementById('time_recorder').innerText = getTimeStamp();
        }

        $('#confirmAttendance_btn').click(function (e) {
            e.preventDefault();
            postReportData()
            getTimeStamp()
            postReportData()
        })

    </script>

</body>

</html>